<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>messageium</title>
    <link rel="shortcut icon" href="chat.png" type="image/png">
    <style>
:root {
    /* Primary theme variables */
    --primary-color: #7289DA;
    --bg-color: #2C2F33;
    --secondary-bg: #36393F;
    --text-color: #FFFFFF;
    --secondary-text: #B9BBBE;
    --message-bg: #40444B;
    --sender-bg: rgba(114, 137, 218, 0.188);
    --error-color: #ED4245;
    --success-color: #43B581;
    --warning-color: #FAA61A;

    /* Advanced styling variables */
    --transition-speed: 0.3s;
    --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    --elevation: 0 4px 20px rgba(0, 0, 0, 0.2);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    transition: all var(--transition-speed) ease;
}

body {
    background-color: var(--bg-color);
    color: var(--text-color);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* Container */
.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
}

/* Header */
header {
    background-color: var(--secondary-bg);
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--box-shadow);
}

.logo {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary-color);
}

.user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.profile-pic {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--primary-color);
}

.username {
    font-weight: 500;
}

.logout-btn {
    background-color: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
}

.logout-btn:hover {
    background-color: var(--primary-color);
    color: var(--text-color);
}

/* Auth Section */
.auth-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 20px;
}

.auth-card {
    background-color: var(--secondary-bg);
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: var(--elevation);
    width: 90%;
    max-width: 400px;
}

.auth-title {
    font-size: 24px;
    margin-bottom: 20px;
    color: var(--primary-color);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.form-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
}

.form-label {
    font-size: 14px;
    color: var(--secondary-text);
}

.form-input {
    width: 100%;
    padding: 12px 15px;
    border: none;
    border-radius: 4px;
    background-color: var(--message-bg);
    color: var(--text-color);
    font-size: 15px;
}

.form-input:focus {
    outline: 1px solid var(--primary-color);
}

.auth-btn {
    background-color: var(--primary-color);
    color: var(--text-color);
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 10px;
}

.auth-btn:hover {
    background-color: #5e77d4;
}

.auth-btn:disabled {
    background-color: #4a5889;
    cursor: not-allowed;
}

.auth-switch {
    margin-top: 20px;
    font-size: 14px;
    color: var(--secondary-text);
}

.auth-switch a {
    color: var(--primary-color);
    text-decoration: none;
    cursor: pointer;
}

.auth-switch a:hover {
    text-decoration: underline;
}

.auth-error {
    color: var(--error-color);
    font-size: 14px;
    margin-top: 10px;
    text-align: left;
}

.auth-success {
    color: var(--success-color);
    font-size: 14px;
    margin-top: 10px;
}

.auth-warning {
    color: var(--warning-color);
    font-size: 14px;
    margin-top: 10px;
    text-align: center;
    background-color: rgba(250, 166, 26, 0.1);
    padding: 10px;
    border-radius: 4px;
    border: 1px solid var(--warning-color);
}

.auth-info {
    margin-top: 15px;
    background-color: rgba(114, 137, 218, 0.1);
    padding: 10px;
    border-radius: 4px;
    border: 1px solid var(--primary-color);
    font-size: 14px;
    text-align: center;
}

.resend-link {
    color: var(--primary-color);
    text-decoration: none;
    cursor: pointer;
    font-weight: bold;
}

.resend-link:hover {
    text-decoration: underline;
}

/* Profile Setup */
.profile-setup {
    display: flex;
    flex-direction: column;
    gap: 20px;
    width: 100%;
}

.profile-pic-setup {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}

.profile-pic-preview {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: var(--message-bg);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 32px;
    color: var(--secondary-text);
    overflow: hidden;
}

/* Email Verification */
.verification-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    padding: 20px;
}

.verification-card {
    background-color: var(--secondary-bg);
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: var(--elevation);
    width: 90%;
    max-width: 500px;
}

.verification-icon {
    font-size: 48px;
    color: var(--warning-color);
    margin-bottom: 20px;
}

.verification-title {
    font-size: 24px;
    margin-bottom: 10px;
    color: var(--primary-color);
}

.verification-message {
    margin-bottom: 20px;
    line-height: 1.5;
}

.verification-email {
    font-weight: bold;
    color: var(--primary-color);
}

.verification-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
}

.verification-btn {
    background-color: var(--primary-color);
    color: var(--text-color);
    padding: 12px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.verification-btn:hover {
    background-color: #5e77d4;
}

.verification-btn.secondary {
    background-color: transparent;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
}

.verification-btn.secondary:hover {
    background-color: rgba(114, 137, 218, 0.1);
}

/* Chat Section */
.chat-container {
    display: flex;
    flex: 1;
    overflow: hidden;
}

/* Sidebar */
.users-sidebar {
    width: 250px;
    background-color: var(--secondary-bg);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 15px;
    font-weight: 500;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.users-list {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border-radius: 4px;
    cursor: pointer;
}

.user-item:hover {
    background-color: var(--message-bg);
}

.user-item.active {
    background-color: var(--primary-color);
    color: var(--text-color);
}

.user-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 16px;
    background-color: var(--message-bg);
    color: var(--text-color);
}

.user-name {
    font-size: 15px;
    font-weight: 500;
    flex: 1;
}

.user-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--success-color);
}

/* Chat Content */
.chat-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    height: 100%;
}

.chat-header {
    padding: 15px;
    background-color: var(--secondary-bg);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-recipient {
    font-weight: 500;
}

.empty-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: var(--secondary-text);
    text-align: center;
    padding: 20px;
}

.empty-chat-icon {
    font-size: 48px;
    margin-bottom: 15px;
    color: var(--primary-color);
}

/* Messages */
.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding-bottom: 80px; /* Add padding to ensure messages aren't hidden behind input */
}

.message {
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 70%;
    word-break: break-word;
    position: relative;
    animation: fadeIn var(--transition-speed);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.other-message {
    background-color: var(--message-bg);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.my-message {
    background-color: var(--primary-color);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
}

.message-sender {
    font-weight: 500;
    font-size: 14px;
}

.message-time {
    font-size: 12px;
    color: var(--secondary-text);
}

.message-pic {
    width: 25px;
    height: 25px;
    border-radius: 50%;
}

.message-content {
    font-size: 15px;
    line-height: 1.4;
}

/* Input Section - Fixed at bottom */
.input-container {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    gap: 10px;
    padding: 15px;
    background-color: var(--secondary-bg);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    z-index: 100;
    max-width: 950px; /* Match the width of the chat content */
    margin: 0 auto;
    width: calc(100% - 250px); /* Account for sidebar width */
    margin-left: 325px; /* Match sidebar width */
}

.message-input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    border-radius: 4px;
    background-color: var(--message-bg);
    color: var(--text-color);
    font-size: 15px;
    max-height: 100px;
    overflow-y: auto;
    resize: none;
}

.message-input:focus {
    outline: 1px solid var(--primary-color);
}

.send-btn {
    background-color: var(--primary-color);
    color: var(--text-color);
    border: none;
    border-radius: 4px;
    padding: 0 20px;
    cursor: pointer;
    height: 42px;
}

.send-btn:hover {
    background-color: #5e77d4;
}

.send-btn:disabled {
    background-color: #4a5889;
    cursor: not-allowed;
}

/* Loader */
.loader-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loader {
    border: 5px solid var(--secondary-bg);
    border-top: 5px solid var(--primary-color);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Toast Notification */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 20px;
    border-radius: 4px;
    color: white;
    font-weight: 500;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    animation: slideIn 0.3s, fadeOut 0.5s 2.5s forwards;
    max-width: 300px;
}

.toast.success {
    background-color: var(--success-color);
}

.toast.error {
    background-color: var(--error-color);
}

.toast.warning {
    background-color: var(--warning-color);
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; visibility: hidden; }
}

/* Responsive Design */

/* Tablets & small laptops */
@media (max-width: 768px) {
    .chat-container {
        flex-direction: column;
    }

    .users-sidebar {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message {
        max-width: 85%;
    }

    .auth-card, .verification-card {
        padding: 20px;
        width: 95%;
    }

    .profile-pic {
        width: 30px;
        height: 30px;
    }

    .username {
        font-size: 14px;
    }

    .logo {
        font-size: 20px;
    }

    .logout-btn {
        padding: 4px 10px;
        font-size: 14px;
    }
    
    /* Fix input container for mobile layout */
    .input-container {
        width: 100%;
        margin-left: 0;
        padding: 10px;
    }

    .message-input {
        padding: 10px;
    }

    .send-btn {
        padding: 0 15px;
    }
    
    /* Adjust message container padding for fixed input */
    .messages-container {
        padding-bottom: 70px;
    }
}

/* Mobile phones */
@media (max-width: 480px) {
    .auth-card, .verification-card {
        padding: 15px;
        width: 100%;
    }

    .message {
        max-width: 90%;
        padding: 8px 12px;
    }

    .messages-container {
        padding: 10px;
        padding-bottom: 65px;
    }

    .logo {
        font-size: 18px;
    }

    .user-info {
        gap: 5px;
    }

    header {
        padding: 10px;
    }
    
    /* Further adjust input container for smaller screens */
    .input-container {
        padding: 8px;
    }
    
    .message-input {
        font-size: 14px;
    }
    
    .send-btn {
        padding: 0 12px;
        height: 38px;
    }
}
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="auth-container">
        <div class="auth-card">
            <h1 class="auth-title">Login to messageium</h1>
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <label for="login-email" class="form-label">Email Address</label>
                    <input type="email" id="login-email" class="form-input" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="login-password" class="form-label">Password</label>
                    <input type="password" id="login-password" class="form-input" placeholder="Your password" required>
                </div>
                <div id="login-error" class="auth-error" style="display: none;"></div>
                <button type="submit" id="login-btn" class="auth-btn">Login</button>
            </form>
            <div class="auth-switch">
                Don't have an account? <a id="to-signup">Sign up</a>
            </div>
            <div class="auth-switch">
                <a id="to-reset-password">Forgot password?</a>
            </div>
        </div>
    </div>

    <!-- Signup Section -->
    <div id="signup-section" class="auth-container" style="display: none;">
        <div class="auth-card">
            <h1 class="auth-title">Create an Account</h1>
            <form id="signup-form" class="auth-form">
                <div class="form-group">
                    <label for="signup-email" class="form-label">Email Address</label>
                    <input type="email" id="signup-email" class="form-input" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signup-password" class="form-label">Password</label>
                    <input type="password" id="signup-password" class="form-input" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="signup-confirm" class="form-label">Confirm Password</label>
                    <input type="password" id="signup-confirm" class="form-input" placeholder="Confirm your password" required>
                </div>
                <div id="signup-error" class="auth-error" style="display: none;"></div>
                <button type="submit" id="signup-btn" class="auth-btn">Sign Up</button>
            </form>
            <div class="auth-info">
                By signing up, you'll receive a verification email to activate your account.
            </div>
            <div class="auth-switch">
                Already have an account? <a id="to-login">Login</a>
            </div>
        </div>
    </div>

    <!-- Email Verification Section -->
    <div id="verification-section" class="verification-container" style="display: none;">
        <div class="verification-card">
            <div class="verification-icon">‚úâÔ∏è</div>
            <h1 class="verification-title">Verify Your Email</h1>
            <p class="verification-message">
                We've sent a verification link to <span id="verification-email" class="verification-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="bfc6d0cacdffdad2ded6d391dcd0d2">[email&#160;protected]</a></span>
            </p>
            <p class="verification-message">
                Please check your inbox and click on the link to verify your email address. If you don't see the email, check your spam folder.
            </p>
            <div class="verification-actions">
                <button id="check-verification-btn" class="verification-btn">I've Verified My Email</button>
                <button id="resend-verification-btn" class="verification-btn secondary">Resend Verification Email</button>
                <button id="logout-from-verification-btn" class="verification-btn secondary">Use Another Account</button>
            </div>
        </div>
    </div>

    <!-- Reset Password Section -->
    <div id="reset-password-section" class="auth-container" style="display: none;">
        <div class="auth-card">
            <h1 class="auth-title">Reset Password</h1>
            <form id="reset-password-form" class="auth-form">
                <div class="form-group">
                    <label for="reset-email" class="form-label">Email Address</label>
                    <input type="email" id="reset-email" class="form-input" placeholder="your@email.com" required>
                </div>
                <div id="reset-error" class="auth-error" style="display: none;"></div>
                <div id="reset-success" class="auth-success" style="display: none;"></div>
                <button type="submit" id="reset-btn" class="auth-btn">Send Reset Link</button>
            </form>
            <div class="auth-switch">
                <a id="back-to-login">Back to Login</a>
            </div>
        </div>
    </div>

    <!-- Profile Setup Section -->
    <div id="profile-section" class="auth-container" style="display: none;">
        <div class="auth-card">
            <h1 class="auth-title">Set Up Your Profile</h1>
            <form id="profile-form" class="auth-form">
                <div class="profile-pic-setup">
                    <div id="profile-pic-preview" class="profile-pic-preview">
                        ?
                    </div>
                </div>
                <div class="form-group">
                    <label for="display-name" class="form-label">Display Name</label>
                    <input type="text" id="display-name" class="form-input" placeholder="How others will see you" required>
                </div>
                <div class="form-group">
                    <label for="avatar-color" class="form-label">Avatar Color</label>
                    <input type="color" id="avatar-color" class="form-input" value="#7289DA">
                </div>
                <div id="profile-error" class="auth-error" style="display: none;"></div>
                <button type="submit" id="profile-btn" class="auth-btn">Continue to Chat</button>
            </form>
        </div>
    </div>

    <!-- Chat Section -->
    <div id="chat-section" class="app-container" style="display: none;">
        <header>
            <div class="logo">messageium</div>
            <div class="user-info">
                <div id="user-pic" class="profile-pic"></div>
                <span id="user-name" class="username">User</span>
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>
        </header>

        <div class="chat-container">
            <!-- Users sidebar -->
            <div class="users-sidebar">
                <div class="sidebar-header">All Users</div>
                <div id="users-list" class="users-list">
                    <!-- Users will be added here -->
                </div>
            </div>

            <!-- Chat content -->
            <div class="chat-content">
                <!-- Empty chat view (shown when no chat is selected) -->
                <div id="empty-chat" class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3>Select a user to start chatting</h3>
                    <p>Choose someone from the list to start a private conversation</p>
                </div>

                <!-- Active chat view (hidden by default) -->
                <div id="active-chat" style="display: none; flex-direction: column; flex: 1; overflow: hidden;">
                    <div id="chat-header" class="chat-header">
                        <div id="recipient-avatar" class="user-avatar"></div>
                        <span id="recipient-name" class="chat-recipient">User</span>
                    </div>

                    <div id="messages" class="messages-container">
                        <!-- Messages will be added here -->
                    </div>

                    <div class="input-container">
                        <input type="text" id="message-input" class="message-input" placeholder="Type a message..." autocomplete="off">
                        <button id="send-btn" class="send-btn" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loader-overlay" class="loader-overlay" style="display: none;">
        <div class="loader"></div>
    </div>

    <!-- Firebase SDK -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAK-NzCqQSCiLn5WSSf-5tWbsO5nSyubEk",
            authDomain: "best-msg-4cb83.firebaseapp.com",
            projectId: "best-msg-4cb83",
            storageBucket: "best-msg-4cb83.firebasestorage.app",
            messagingSenderId: "94214242826",
            appId: "1:94214242826:web:f02a0deb024e43a32fd5f3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get references to Firebase services
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements - Auth
        const loginSection = document.getElementById('login-section');
        const signupSection = document.getElementById('signup-section');
        const verificationSection = document.getElementById('verification-section');
        const resetPasswordSection = document.getElementById('reset-password-section');
        const profileSection = document.getElementById('profile-section');
        const chatSection = document.getElementById('chat-section');
        const loaderOverlay = document.getElementById('loader-overlay');
        
        const loginForm = document.getElementById('login-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        
        const signupForm = document.getElementById('signup-form');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupConfirm = document.getElementById('signup-confirm');
        const signupError = document.getElementById('signup-error');
        
        const verificationEmailSpan = document.getElementById('verification-email');
        const checkVerificationBtn = document.getElementById('check-verification-btn');
        const resendVerificationBtn = document.getElementById('resend-verification-btn');
        const logoutFromVerificationBtn = document.getElementById('logout-from-verification-btn');
        
        const resetPasswordForm = document.getElementById('reset-password-form');
        const resetEmail = document.getElementById('reset-email');
        const resetError = document.getElementById('reset-error');
        const resetSuccess = document.getElementById('reset-success');
        
        const profileForm = document.getElementById('profile-form');
        const displayName = document.getElementById('display-name');
        const avatarColor = document.getElementById('avatar-color');
        const profilePicPreview = document.getElementById('profile-pic-preview');
        const profileError = document.getElementById('profile-error');
        
        // DOM Elements - Chat
        const logoutBtn = document.getElementById('logout-btn');
        const usersList = document.getElementById('users-list');
        const emptyChat = document.getElementById('empty-chat');
        const activeChat = document.getElementById('active-chat');
        const chatHeader = document.getElementById('chat-header');
        const recipientAvatar = document.getElementById('recipient-avatar');
        const recipientName = document.getElementById('recipient-name');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const userPic = document.getElementById('user-pic');
        const userName = document.getElementById('user-name');

        // Global variables
        let currentUser = null;
        let userProfile = null;
        let selectedUser = null;
        let messagesUnsubscribe = null;
        let usersUnsubscribe = null;

        // Show loading overlay
        function showLoader() {
            loaderOverlay.style.display = 'flex';
        }

        // Hide loading overlay
        function hideLoader() {
            loaderOverlay.style.display = 'none';
        }

        // Show toast notification - continues from where it was cut off
function showToast(message, type = 'success') {
    // Remove any existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Remove toast after animation
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Navigate between authentication sections
document.getElementById('to-signup').addEventListener('click', () => {
    loginSection.style.display = 'none';
    signupSection.style.display = 'flex';
    clearFormErrors();
});

document.getElementById('to-login').addEventListener('click', () => {
    signupSection.style.display = 'none';
    loginSection.style.display = 'flex';
    clearFormErrors();
});

document.getElementById('to-reset-password').addEventListener('click', () => {
    loginSection.style.display = 'none';
    resetPasswordSection.style.display = 'flex';
    clearFormErrors();
});

document.getElementById('back-to-login').addEventListener('click', () => {
    resetPasswordSection.style.display = 'none';
    loginSection.style.display = 'flex';
    clearFormErrors();
});

// Clear form errors
function clearFormErrors() {
    loginError.style.display = 'none';
    signupError.style.display = 'none';
    resetError.style.display = 'none';
    resetSuccess.style.display = 'none';
    profileError.style.display = 'none';
}

// Login form submission
loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFormErrors();
    
    const email = loginEmail.value.trim();
    const password = loginPassword.value;
    
    if (!email || !password) {
        loginError.textContent = 'Please enter both email and password';
        loginError.style.display = 'block';
        return;
    }
    
    showLoader();
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
        // Auth state change listener will handle redirection
    } catch (error) {
        hideLoader();
        loginError.textContent = error.message;
        loginError.style.display = 'block';
    }
});

// Signup form submission
signupForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFormErrors();
    
    const email = signupEmail.value.trim();
    const password = signupPassword.value;
    const confirm = signupConfirm.value;
    
    if (!email || !password || !confirm) {
        signupError.textContent = 'Please fill out all fields';
        signupError.style.display = 'block';
        return;
    }
    
    if (password !== confirm) {
        signupError.textContent = 'Passwords do not match';
        signupError.style.display = 'block';
        return;
    }
    
    if (password.length < 6) {
        signupError.textContent = 'Password must be at least 6 characters';
        signupError.style.display = 'block';
        return;
    }
    
    showLoader();
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.sendEmailVerification();
        verificationEmailSpan.textContent = email;
        signupSection.style.display = 'none';
        verificationSection.style.display = 'flex';
        hideLoader();
    } catch (error) {
        hideLoader();
        signupError.textContent = error.message;
        signupError.style.display = 'block';
    }
});

// Reset password form submission
resetPasswordForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFormErrors();
    
    const email = resetEmail.value.trim();
    
    if (!email) {
        resetError.textContent = 'Please enter your email address';
        resetError.style.display = 'block';
        return;
    }
    
    showLoader();
    
    try {
        await auth.sendPasswordResetEmail(email);
        resetSuccess.textContent = 'Password reset link sent to your email';
        resetSuccess.style.display = 'block';
        resetEmail.value = '';
        hideLoader();
    } catch (error) {
        hideLoader();
        resetError.textContent = error.message;
        resetError.style.display = 'block';
    }
});

// Check email verification
checkVerificationBtn.addEventListener('click', async () => {
    showLoader();
    
    try {
        await auth.currentUser.reload();
        if (auth.currentUser.emailVerified) {
            verificationSection.style.display = 'none';
            profileSection.style.display = 'flex';
        } else {
            showToast('Your email is not verified yet. Please check your inbox.', 'warning');
        }
        hideLoader();
    } catch (error) {
        hideLoader();
        showToast(error.message, 'error');
    }
});

// Resend verification email
resendVerificationBtn.addEventListener('click', async () => {
    showLoader();
    
    try {
        await auth.currentUser.sendEmailVerification();
        showToast('Verification email resent. Please check your inbox.', 'success');
        hideLoader();
    } catch (error) {
        hideLoader();
        showToast(error.message, 'error');
    }
});

// Logout from verification
logoutFromVerificationBtn.addEventListener('click', async () => {
    try {
        await auth.signOut();
        // Auth state change listener will handle redirection
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Profile form submission
profileForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFormErrors();
    
    const name = displayName.value.trim();
    const color = avatarColor.value;
    
    if (!name) {
        profileError.textContent = 'Please enter a display name';
        profileError.style.display = 'block';
        return;
    }
    
    showLoader();
    
    try {
        // Save user profile to Firestore
        await db.collection('users').doc(auth.currentUser.uid).set({
            displayName: name,
            avatarColor: color,
            email: auth.currentUser.email,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        profileSection.style.display = 'none';
        chatSection.style.display = 'flex';
        hideLoader();
    } catch (error) {
        hideLoader();
        profileError.textContent = error.message;
        profileError.style.display = 'block';
    }
});

// Logout button
logoutBtn.addEventListener('click', async () => {
    try {
        await auth.signOut();
        // Auth state change listener will handle redirection
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// Update avatar preview
avatarColor.addEventListener('input', () => {
    updateAvatarPreview();
});

displayName.addEventListener('input', () => {
    updateAvatarPreview();
});

function updateAvatarPreview() {
    const initials = displayName.value.trim() ? displayName.value.trim()[0].toUpperCase() : '?';
    profilePicPreview.style.backgroundColor = avatarColor.value;
    profilePicPreview.textContent = initials;
}

// Generate avatar element
function generateAvatar(name, color) {
    const initial = name ? name[0].toUpperCase() : '?';
    const avatar = document.createElement('div');
    avatar.className = 'user-avatar';
    avatar.style.backgroundColor = color || '#7289DA';
    avatar.textContent = initial;
    return avatar;
}

// Chat functionality
messageInput.addEventListener('input', () => {
    sendBtn.disabled = !messageInput.value.trim();
});

sendBtn.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

async function sendMessage() {
    if (!messageInput.value.trim() || !selectedUser) return;
    
    const messageText = messageInput.value.trim();
    messageInput.value = '';
    sendBtn.disabled = true;
    
    try {
        // Create a chat ID that's the same for both users
        const chatId = [currentUser.uid, selectedUser.id].sort().join('_');
        
        // Add message to Firestore
        await db.collection('chats').doc(chatId).collection('messages').add({
            text: messageText,
            senderId: currentUser.uid,
            receiverId: selectedUser.id,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        showToast(error.message, 'error');
    }
}

// Select a user to chat with
function selectUser(user) {
    // Clear previous selection
    const activeUserElements = document.querySelectorAll('.user-item.active');
    activeUserElements.forEach(el => el.classList.remove('active'));
    
    // Update selection
    selectedUser = user;
    document.getElementById(`user-${user.id}`).classList.add('active');
    
    // Update chat header
    recipientName.textContent = user.displayName;
    recipientAvatar.innerHTML = '';
    recipientAvatar.appendChild(generateAvatar(user.displayName, user.avatarColor));
    
    // Show active chat
    emptyChat.style.display = 'none';
    activeChat.style.display = 'flex';
    
    // Clear messages
    messagesContainer.innerHTML = '';
    
    // Unsubscribe from previous messages listener
    if (messagesUnsubscribe) {
        messagesUnsubscribe();
    }
    
    // Listen for messages
    const chatId = [currentUser.uid, user.id].sort().join('_');
    messagesUnsubscribe = db.collection('chats').doc(chatId).collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const message = change.doc.data();
                    displayMessage(message);
                }
            });
            // Scroll to bottom after new messages
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, error => {
            console.error("Error getting messages: ", error);
            showToast(error.message, 'error');
        });
}

// Display a message
function displayMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.senderId === currentUser.uid ? 'my-message' : 'other-message'}`;
    
    const timestamp = message.timestamp ? message.timestamp.toDate() : new Date();
    const time = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Get sender info
    const isMine = message.senderId === currentUser.uid;
    const senderName = isMine ? userProfile.displayName : selectedUser.displayName;
    const senderColor = isMine ? userProfile.avatarColor : selectedUser.avatarColor;
    
    messageDiv.innerHTML = `
        <div class="message-header">
            ${generateAvatar(senderName, senderColor).outerHTML}
            <span class="message-sender">${senderName}</span>
            <span class="message-time">${time}</span>
        </div>
        <div class="message-content">${message.text}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
}

// Load users
function loadUsers() {
    if (usersUnsubscribe) {
        usersUnsubscribe();
    }
    
    usersList.innerHTML = '';
    
    usersUnsubscribe = db.collection('users')
        .where('email', '!=', currentUser.email)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const user = { id: change.doc.id, ...change.doc.data() };
                    addUserToList(user);
                } else if (change.type === 'modified') {
                    const user = { id: change.doc.id, ...change.doc.data() };
                    updateUserInList(user);
                } else if (change.type === 'removed') {
                    removeUserFromList(change.doc.id);
                }
            });
        }, error => {
            console.error("Error getting users: ", error);
            showToast(error.message, 'error');
        });
}

// Add a user to the users list
function addUserToList(user) {
    const userItem = document.createElement('div');
    userItem.className = 'user-item';
    userItem.id = `user-${user.id}`;
    
    userItem.innerHTML = `
        <div class="user-status"></div>
        <span class="user-name">${user.displayName}</span>
    `;
    
    userItem.prepend(generateAvatar(user.displayName, user.avatarColor));
    
    userItem.addEventListener('click', () => {
        selectUser(user);
    });
    
    usersList.appendChild(userItem);
}

// Update a user in the users list
function updateUserInList(user) {
    const userItem = document.getElementById(`user-${user.id}`);
    if (userItem) {
        userItem.querySelector('.user-name').textContent = user.displayName;
        const avatar = generateAvatar(user.displayName, user.avatarColor);
        userItem.querySelector('.user-avatar').replaceWith(avatar);
    }
}

// Remove a user from the users list
function removeUserFromList(userId) {
    const userItem = document.getElementById(`user-${userId}`);
    if (userItem) {
        userItem.remove();
    }
}

// Auth state change listener
auth.onAuthStateChanged(async user => {
    hideLoader();
    
    if (user) {
        currentUser = user;
        
        // Hide all auth sections
        loginSection.style.display = 'none';
        signupSection.style.display = 'none';
        resetPasswordSection.style.display = 'none';
        
        if (!user.emailVerified) {
            // Show verification section
            verificationEmailSpan.textContent = user.email;
            verificationSection.style.display = 'flex';
            return;
        }
        
        try {
            // Check if user has a profile
            const profileDoc = await db.collection('users').doc(user.uid).get();
            
            if (profileDoc.exists) {
                // User has a profile, show chat
                userProfile = profileDoc.data();
                
                // Update header with user info
                userName.textContent = userProfile.displayName;
                userPic.innerHTML = '';
                userPic.appendChild(generateAvatar(userProfile.displayName, userProfile.avatarColor));
                
                chatSection.style.display = 'flex';
                
                // Load users
                loadUsers();
            } else {
                // User needs to create a profile
                profileSection.style.display = 'flex';
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    } else {
        // User is signed out
        currentUser = null;
        userProfile = null;
        selectedUser = null;
        
        // Unsubscribe from listeners
        if (messagesUnsubscribe) {
            messagesUnsubscribe();
            messagesUnsubscribe = null;
        }
        
        if (usersUnsubscribe) {
            usersUnsubscribe();
            usersUnsubscribe = null;
        }
        
        // Show login section
        chatSection.style.display = 'none';
        profileSection.style.display = 'none';
        verificationSection.style.display = 'none';
        resetPasswordSection.style.display = 'none';
        signupSection.style.display = 'none';
        loginSection.style.display = 'flex';
    }
});

// Initialize the app
function init() {
    // Update avatar preview
    updateAvatarPreview();
}

// Run initialization
init();
</script>
</body>
</html>
